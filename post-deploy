#!/usr/bin/env bash
set -eo pipefail; [[ $DOKKU_TRACE ]] && set -x

declare APP="$1"

if [[ -f "$DOKKU_ROOT/$APP/SLACK_URL" || -f "$DOKKU_ROOT/SLACK_URL" ]]; then
  echo "-----> Notifying Slack ..."

  SLACK_URL=$(cat "$DOKKU_ROOT/$APP/SLACK_URL" 2> /dev/null || cat "$DOKKU_ROOT/SLACK_URL" 2> /dev/null)

  NEW_REV=$(cat "$DOKKU_ROOT/$APP/SLACK_NEW_REV" 2> /dev/null)
  OLD_REV=$(cat "$DOKKU_ROOT/$APP/SLACK_OLD_REV" 2> /dev/null)

  if [ "${OLD_REV}" != "" ]; then
    TEXT="Deployed ${OLD_REV}...${NEW_REV} to ${APP}"
  else
    TEXT="Deployed ${NEW_REV} to ${APP}"
  fi

  SLACK_JSON="{\
    \"username\": \"Dokku Notifier\", \
    \"text\": \"$TEXT\", \
    \"icon_emoji\": \":package:\" \
  }"
  RESPONSE_CODE=$(curl -s -o/dev/null -d "payload=$SLACK_JSON" "${SLACK_URL}" -w "%{http_code}")
  echo "       HTTP ${RESPONSE_CODE}"
fi
